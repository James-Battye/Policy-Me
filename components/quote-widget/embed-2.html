<script>
  var errorMsg = "";
  var anchorElement = document.querySelector('a.get-my-quote-button');
  var buttonElement = document.createElement('button');
  var formD = { hasPartner: false, ind: {}, partner: {} };

  buttonElement.setAttribute("class", "get-my-quote-button w-button");
  buttonElement.innerHTML = anchorElement.innerHTML;
  anchorElement.parentNode.replaceChild(buttonElement, anchorElement);

  document.addEventListener("DOMContentLoaded", function () {
    var self_birthdate = document.querySelector("#self-Birthdate");
    var partner_birthdate = document.querySelector("#partner-Birthdate");
    var self_hints = document.querySelector("#self-dob-hints");
    var partner_hints = document.querySelector("#partner-dob-hints");
    const submitButton = document.querySelector(".get-my-quote-button");
    self_birthdate.addEventListener("input", function () {
      formatDate(this);
      if (this.value) {
        self_hints.style.display = 'block';
      } else {
        self_hints.style.display = 'none';
      };
    });
    partner_birthdate.addEventListener("input", function () {
      formatDate(this);
      if (this.value) {
        partner_hints.style.display = 'block';
      } else {
        partner_hints.style.display = 'none';
      };
    });
    submitButton.addEventListener("click", function () {
      submitForm();
    });
  });

  function formatDate(input) {
    let value = input.value.replace(/\D/g, "");
    if (value.length > 4) {
      value =
        value.slice(0, 2) + "/" + value.slice(2, 4) + "/" + value.slice(4, 8);
    } else if (value.length > 2) {
      value = value.slice(0, 2) + "/" + value.slice(2);
    }
    input.value = value;
  }

  function isValidDate(dateString) {
    var regex = /^\d{2}\/\d{2}\/\d{4}$/;
    if (!regex.test(dateString)) {
      errorMsg = "Invalid date";
      return false;
    }
    var parts = dateString.split("/");
    var day = parseInt(parts[0], 10);
    var month = parseInt(parts[1], 10);
    var year = parseInt(parts[2], 10);
    if (month < 1 || month > 12) {
      errorMsg = "Month must be in between 01 and 12";
      return false;
    }
    var daysInMonth = new Date(year, month, 0).getDate();
    if (day < 1 || day > daysInMonth) {
      errorMsg = "Invalid date";
      return false;
    }
    if (year < 1000 || year > 9999) {
      return false;
    }
    var inputDate = new Date(year, month - 1, day);
    var ageDiffMilliseconds = Date.now() - inputDate.getTime();
    var ageDate = new Date(ageDiffMilliseconds);
    var age = Math.abs(ageDate.getUTCFullYear() - 1970);
    if (age < 18) {
      errorMsg = "Must be at least 18"
      return false;
    }
    if (age > 75) {
      errorMsg = "Must be 75 or under"
      return false;
    }
    return true;
  }

  function submitForm() {
    let errors = document.querySelectorAll(".quotes-widget-error");
    for (e of errors) {
      e.style.display = "none";
    }
    let hasAllFields = true;
    const birthdate = document.querySelector("#self-Birthdate").value;
    const p_birthdate = document.querySelector("#partner-Birthdate").value;

    if (!birthdate) {
      hasAllFields = false;
      errorMsg = "Required field";
      document.getElementById("dob-input-error").style.display = "block";
    }
    if (!formD['ind']['gender']) {
      hasAllFields = false;
      document.getElementById("gender-input-error").style.display = "block";
    }
    if (!formD['ind']['smoker']) {
      hasAllFields = false;
      document.getElementById("smoker-input-error").style.display = "block";
    }
    if (formD.hasPartner) {
      if (!p_birthdate) { document.getElementById("dob-input-error").style.display = "block"; errorMsg = "Required field"; hasAllFields = false; };
      if (!formD['partner']['gender']) { document.getElementById("gender-input-error").style.display = "block"; hasAllFields = false; };
      if (!formD['partner']['smoker']) { document.getElementById("smoker-input-error").style.display = "block"; hasAllFields = false; }
    }
    if (hasAllFields && isValidDate(birthdate) && (!formD.hasPartner || isValidDate(p_birthdate))) {
      for (e of errors) {
        e.style.display = "none";
      }
      window.analytics && window.analytics.track('Quote Widget Form Submitted', { ...utmCookies, from: window.location.href });
      var uri = `https://${window.location.host}/life/ci/life-insurance-quotes-continued?birthdate=${birthdate.replaceAll(
        "/",
        ""
      )}&smoker=${formD.ind.smoker}&gender=${formD.ind.gender}`;
      if (formD.hasPartner) uri = uri + `&partner=true&partner_smoker=${formD.partner.smoker}` + `&partner_birthdate=${p_birthdate.replaceAll(
        "/",
        ""
      )}` + `&partner_gender=${formD.partner.gender}`;
      const url_ = new URL(window.location.href);
      const moreUrlParams = new URLSearchParams(url_.search);
      let queryString = '';
      moreUrlParams.forEach((value, key) => {
        queryString += `&${key}=${value}`;
      });
      uri = uri + queryString;
      window.open(
        uri,
        "_blank"
      );
    } else {
      const dobError = document.getElementById("dob-input-error");
      dobError.style.display = "block";
      dobError.textContent = errorMsg;
    }
  }


  var optionGroups = document.querySelectorAll(
    ".quotes-widget-radio-row .quotes-widget-options"
  );
  optionGroups.forEach(function (group) {
    var options = group.querySelectorAll(".quotes-tab-btn");
    options.forEach(function (option) {
      option.addEventListener("click", function () {
        var parentGroup = this.closest(".quotes-widget-options");
        var innerDivs = parentGroup.querySelectorAll(".quotes-tab-btn");
        innerDivs.forEach(function (div) {
          if (div !== option) {
            div.classList.remove("w--current");
          }
        });
        var [person, category, value] = option.id.split("-");
        if (category == "application") {
          var partnerOptions = document.querySelectorAll(
            ".quotes-widget-partner"
          );
          partnerOptions.forEach(function (o) {
            if (person == "ind") { o.classList.add("hidden"); formD.hasPartner = false; }
            else { o.classList.remove("hidden"); formD.hasPartner = true; }
          });
        }
        if (category && value) {
          formD[person][category] = value;
        }
        option.classList.add("w--current");
      });
    });
  });
  document.getElementById("ind-application").click();


</script>